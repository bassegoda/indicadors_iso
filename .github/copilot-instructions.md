# Copilot Instructions for indicadors_iso

- Purpose: small collection of hospital analytics scripts; each subfolder holds one-off analyses driven by SQL files and MySQL data.
- DB access: credentials loaded via Windows/Mac lookup in connection helper [connection.py](connection.py). Expect config.ini under Documents/.sql_config with [DEFAULT] host, user, password, database. Choose db_name override only when needed.
- Query execution pattern: use execute_query from [connection.py](connection.py) to run SELECT and return pandas DataFrame; it times execution, uses dictionary cursor, and closes connection in finally.
- Path bootstrap: scripts add project root to sys.path using pathlib (see [deliris/deliris.py](deliris/deliris.py), [demographics/demo.py](demographics/demo.py), [micro/get_tables.py](micro/get_tables.py), [nutritions/nutritions_2025.py](nutritions/nutritions_2025.py)). Reuse that pattern for new modules to import connection.
- SQL storage: keep long SQL in sibling .sql files and load with UTF-8; examples in deliris.sql, micro.sql, antibiogram.sql. Prefer editing SQL files, not embedding large strings unless templated like [demographics/demo.py](demographics/demo.py).
- Demographics cohort workflow: [demographics/demo.py](demographics/demo.py) builds a CTE-based SQL via format(year, units), fetches data, maps categorical values, and uses tableone.TableOne to render HTML into demographics/output. When adding variables, update columns, categorical, nonnormal, and labels together.
- Delirium analysis: [deliris/deliris.py](deliris/deliris.py) reads deliris.sql, maps result_txt codes to textual labels, builds seaborn barplot sorted by counts, saves PNG to deliris folder, then reports proportions for ICU E073/I073. Keep plotting style (viridis palette, bar_label) and output path convention.
- Microbiology exports: [micro/get_tables.py](micro/get_tables.py) runs micro.sql and antibiogram.sql, writes CSVs (micro_data.csv, antibiogram_data.csv) in CWD. Expect potentially large datasets; avoid eager prints beyond counts.
- Nutrition timing: [nutritions/nutritions_2025.py](nutritions/nutritions_2025.py) defines constants for date range/units, builds CTE matching first nutrition prescription per episode, computes hours_difference, and prints counts/percentages and mean times by drug type. When adjusting period or units, change START_DATE/END_DATE/UNIT1/UNIT2 constants.
- Schema discovery: [schema_extraction/extract_schema.py](schema_extraction/extract_schema.py) prompts for password, connects to datascope4, fetches all view columns (excluding dic_% tables), and writes plain text docs to schema_extraction/db_documentation.txt. Leave interactive password prompt to avoid storing secrets.
- Simple plotting utility: [snisp/analysis_2025.py](snisp/analysis_2025.py) loads Excel incidents file and provides plot_pie_from_column helper that saves pie charts with percent and counts; use as template for other categorical pie charts.
- Outputs: many scripts write artifacts alongside their folder (PNG, CSV, HTML). Ensure output directories exist (demographics/output created in code) or create via Path.mkdir(exist_ok=True).
- Dependencies: see [requirements.txt](requirements.txt) (pandas, matplotlib, seaborn, tableone, mysql-connector-python). Install before running scripts; no global project runnerâ€”invoke scripts directly with python path/to/script.py.
- Coding conventions: keep ASCII text in code; logging/prints are concise, often Catalan/Spanish. Use pathlib over os.path where possible; prefer DataFrame.replace/map for recoding; close DB resources via context or finally.
- Testing/debug: there is no test suite. For quick sanity, run scripts against limited date/unit filters to keep queries light; handle empty DataFrames by early exit as done in analyses.
- When adding new analyses: place SQL in the matching folder, import execute_query, follow Path setup pattern, and write outputs locally. Keep credentials out of repo; rely on existing config.ini discovery paths.
